# HEALTH AI CORE SYSTEM - Python Backend
# ======================================
# Complete implementation of the unified health AI system

## 1. UNIFIED DATABASE SCHEMA & CORE MODELS
# File: src/lib/unified_health_ai.py

#!/usr/bin/env python3
"""
Unified Health AI System - Core Database and Models
"""

import sqlite3
import json
import math
import time
import datetime as dt
from pathlib import Path
from typing import List, Optional, Dict, Any, Union
import hashlib

import numpy as np
import pandas as pd
from pydantic import BaseModel, Field, validator
from sklearn.model_selection import TimeSeriesSplit
from sklearn.preprocessing import StandardScaler
from sklearn.pipeline import Pipeline
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import GradientBoostingClassifier
from sklearn.metrics import roc_auc_score, brier_score_loss, classification_report
import joblib

import torch
import torch.nn as nn
from torch.utils.data import Dataset, DataLoader

# Configuration
DB_PATH = Path("unified_health.db")
ROLL_DAYS = 7      # rolling window features
SEQ_LEN = 14       # sequence length for deep model
BATCH_SIZE = 32
LEARNING_RATE = 1e-3
EPOCHS = 10

############################
# 1) DATABASE SCHEMA       #
############################

DDL = """
PRAGMA journal_mode=WAL;
PRAGMA foreign_keys=ON;

-- Core entities
CREATE TABLE IF NOT EXISTS users (
  user_id TEXT PRIMARY KEY,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  timezone TEXT DEFAULT 'UTC',
  preferences TEXT  -- JSON preferences
);

CREATE TABLE IF NOT EXISTS apps (
  app_id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  version TEXT,
  api_endpoint TEXT
);

CREATE TABLE IF NOT EXISTS events (
  event_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  app_id TEXT NOT NULL,
  event_type TEXT NOT NULL,
  event_time TEXT NOT NULL,
  payload_hash TEXT,
  raw_json TEXT NOT NULL,
  processed BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (app_id) REFERENCES apps(app_id)
);

-- Health/time-series data
CREATE TABLE IF NOT EXISTS daily_logs (
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  mood INTEGER CHECK (mood >= 1 AND mood <= 10),
  stress INTEGER CHECK (stress >= 1 AND stress <= 10),
  energy INTEGER CHECK (energy >= 1 AND energy <= 10),
  focus INTEGER CHECK (focus >= 1 AND focus <= 10),
  notes TEXT,
  journal_entry TEXT,
  coping_strategies TEXT,  -- JSON array
  -- Menstrual cycle tracking (for female users)
  menstrual_phase TEXT,  -- "period", "follicular", "luteal", "ovulation"
  cycle_day INTEGER,
  -- Daily flare tracking (target variable for ML)
  daily_flare_status BOOLEAN DEFAULT FALSE,  -- "Did you experience a flare today?"
  flare_type TEXT,  -- "gut", "skin", "mental", "both", "all"
  flare_severity INTEGER CHECK (flare_severity >= 0 AND flare_severity <= 10),
  flare_duration_hours INTEGER,
  -- Recovery/relaxation activities
  recovery_activities TEXT,  -- JSON array: ["meditation", "massage", "sauna", "journaling"]
  meditation_minutes INTEGER,
  relaxation_quality INTEGER CHECK (relaxation_quality >= 1 AND relaxation_quality <= 10),
  PRIMARY KEY (user_id, date),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS symptoms (
  symptom_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'gut', 'skin', 'headache', 'fatigue', 'migraine'
  severity INTEGER CHECK (severity >= 0 AND severity <= 10),
  onset_time TEXT,
  duration_min INTEGER,
  location TEXT,
  triggers TEXT,  -- JSON array
  notes TEXT,
  -- GI specific fields
  reflux_severity INTEGER CHECK (reflux_severity >= 0 AND reflux_severity <= 10),
  bloating_severity INTEGER CHECK (bloating_severity >= 0 AND bloating_severity <= 10),
  abdominal_pain_severity INTEGER CHECK (abdominal_pain_severity >= 0 AND abdominal_pain_severity <= 10),
  stool_consistency INTEGER CHECK (stool_consistency >= 1 AND stool_consistency <= 7),  -- Bristol stool scale
  -- Skin specific fields
  skin_location TEXT,  -- "face", "chest", "back", "arms", etc.
  skin_type TEXT,  -- "acne", "rash", "itchiness", "dryness"
  -- General health
  fatigue_severity INTEGER CHECK (fatigue_severity >= 0 AND fatigue_severity <= 10),
  headache_severity INTEGER CHECK (headache_severity >= 0 AND headache_severity <= 10),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS meals (
  meal_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  ts TEXT NOT NULL,
  items TEXT,
  food_type TEXT,  -- "breakfast", "lunch", "dinner", "snack"
  portion_size TEXT,  -- "small", "medium", "large", "exact_grams"
  portion_grams INTEGER,  -- exact portion in grams
  tags TEXT,  -- JSON array like ["spicy", "dairy", "gluten", "artificial_sweeteners", "fatty"]
  calories INTEGER,
  caffeine_mg INTEGER,
  -- Macronutrients (per serving)
  protein_g REAL,
  carbs_g REAL,
  fat_g REAL,
  fiber_g REAL,
  sugar_g REAL,
  -- Additional macronutrients
  saturated_fat_g REAL,
  monounsaturated_fat_g REAL,
  polyunsaturated_fat_g REAL,
  trans_fat_g REAL,
  cholesterol_mg REAL,
  sodium_mg REAL,
  potassium_mg REAL,
  -- Micronutrients
  vitamin_c_mg REAL,
  vitamin_d_iu REAL,
  calcium_mg REAL,
  iron_mg REAL,
  magnesium_mg REAL,
  zinc_mg REAL,
  artificial_sweeteners BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS sleep_sessions (
  sleep_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  start_time TEXT NOT NULL,
  end_time TEXT NOT NULL,
  total_min INTEGER,
  deep_min INTEGER,
  light_min INTEGER,
  rem_min INTEGER,
  awake_min INTEGER,
  awakenings INTEGER,
  sleep_score REAL CHECK (sleep_score >= 1 AND sleep_score <= 10),
  sleep_factors TEXT,  -- JSON object
  notes TEXT,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS workouts (
  workout_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  ts TEXT NOT NULL,
  type TEXT,  -- 'run', 'weights', 'yoga', 'cycling', 'swimming'
  duration_min INTEGER,
  intensity INTEGER CHECK (intensity >= 1 AND intensity <= 5),
  calories_burned INTEGER,
  heart_rate_avg INTEGER,
  heart_rate_max INTEGER,
  notes TEXT,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS vitals (
  vital_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  hr_mean REAL,
  hr_max REAL,
  hrv_ms REAL,
  spo2 REAL,
  steps INTEGER,
  active_min INTEGER,
  calories_burned INTEGER,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS medications (
  med_code TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT,  -- 'prescription', 'otc', 'supplement'
  instructions TEXT,
  side_effects TEXT,  -- JSON array
  interactions TEXT   -- JSON array
);

CREATE TABLE IF NOT EXISTS med_adherence (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  med_code TEXT NOT NULL,
  ts TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('taken', 'missed', 'late', 'skipped')),
  notes TEXT,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (med_code) REFERENCES medications(med_code)
);

CREATE TABLE IF NOT EXISTS remedies (
  remedy_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  name TEXT NOT NULL,
  category TEXT,  -- 'dietary', 'lifestyle', 'supplement', 'exercise'
  effectiveness_score REAL CHECK (effectiveness_score >= 0 AND effectiveness_score <= 10),
  usage_count INTEGER DEFAULT 0,
  conditions TEXT,  -- JSON array of conditions it helps
  instructions TEXT,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS remedy_usage (
  usage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  remedy_id INTEGER NOT NULL,
  ts TEXT NOT NULL,
  effectiveness REAL CHECK (effectiveness >= 0 AND effectiveness <= 10),
  notes TEXT,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (remedy_id) REFERENCES remedies(remedy_id)
);

-- Vision/NLP data
CREATE TABLE IF NOT EXISTS images (
  image_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  ts TEXT NOT NULL,
  path TEXT NOT NULL,
  body_region TEXT,  -- 'face', 'arms', 'torso', 'legs'
  lighting TEXT,
  camera_info TEXT,  -- JSON object
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS image_labels (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  image_id INTEGER NOT NULL,
  lesion_area_px INTEGER,
  delta_e REAL,
  erythema_idx REAL,
  severity REAL CHECK (severity >= 0 AND severity <= 10),
  mask_path TEXT,
  features_json TEXT,  -- JSON object with computed features
  FOREIGN KEY (image_id) REFERENCES images(image_id)
);

CREATE TABLE IF NOT EXISTS journals (
  journal_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  ts TEXT NOT NULL,
  text TEXT NOT NULL,
  mood_context INTEGER CHECK (mood_context >= 1 AND mood_context <= 10),
  stress_context INTEGER CHECK (stress_context >= 1 AND stress_context <= 10),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS journal_nlp (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  journal_id INTEGER NOT NULL,
  sentiment REAL CHECK (sentiment >= -1 AND sentiment <= 1),
  topics TEXT,  -- JSON array
  embedding BLOB,
  keywords TEXT,  -- JSON array
  FOREIGN KEY (journal_id) REFERENCES journals(journal_id)
);

CREATE TABLE IF NOT EXISTS device_sync (
  sync_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  provider TEXT NOT NULL,  -- 'fitbit', 'apple_health', 'google_fit'
  token_metadata TEXT,  -- JSON object
  last_sync_at TEXT,
  sync_status TEXT DEFAULT 'active',
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- Feature store (materialized)
CREATE TABLE IF NOT EXISTS fs_daily_user (
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  features_json TEXT NOT NULL,
  labels_json TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, date),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS fs_seq_user (
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,  -- sequence ending at this date
  seq_json TEXT NOT NULL,  -- {"X": [[...],[...],...], "Y": {...}}
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, date),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS fs_vision (
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  lesion_features_json TEXT NOT NULL,
  severity_score REAL,
  trend_direction TEXT,  -- 'improving', 'stable', 'worsening'
  PRIMARY KEY (user_id, date),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE IF NOT EXISTS fs_text (
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  sentiment_avg REAL,
  topics_json TEXT,  -- JSON array
  embedding_avg BLOB,
  word_count INTEGER,
  PRIMARY KEY (user_id, date),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- Model storage
CREATE TABLE IF NOT EXISTS model_versions (
  model_id INTEGER PRIMARY KEY AUTOINCREMENT,
  model_type TEXT NOT NULL,  -- 'tabular', 'sequence', 'vision', 'nlp'
  target TEXT NOT NULL,  -- 'gut', 'skin', 'mood'
  version TEXT NOT NULL,
  model_path TEXT NOT NULL,
  metrics_json TEXT,  -- JSON object with performance metrics
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  is_active BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS predictions (
  prediction_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  date TEXT NOT NULL,
  model_type TEXT NOT NULL,
  target TEXT NOT NULL,
  prediction REAL,
  confidence REAL,
  explanation_json TEXT,  -- JSON object with SHAP values
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_events_user_time ON events(user_id, event_time);
CREATE INDEX IF NOT EXISTS idx_symptoms_user_date ON symptoms(user_id, date);
CREATE INDEX IF NOT EXISTS idx_meals_user_ts ON meals(user_id, ts);
CREATE INDEX IF NOT EXISTS idx_sleep_user_start ON sleep_sessions(user_id, start_time);
CREATE INDEX IF NOT EXISTS idx_predictions_user_date ON predictions(user_id, date);
"""

def get_conn():
    """Get database connection with proper settings."""
    conn = sqlite3.connect(DB_PATH.as_posix())
    conn.execute("PRAGMA foreign_keys=ON;")
    conn.execute("PRAGMA journal_mode=WAL;")
    return conn

def init_db():
    """Initialize database with schema."""
    with get_conn() as conn:
        conn.executescript(DDL)
        print("✅ Database initialized successfully")

#########################
# 2) PYDANTIC MODELS    #
#########################

class UserIn(BaseModel):
    user_id: str
    timezone: str = "UTC"
    preferences: Optional[Dict[str, Any]] = None

class EventIn(BaseModel):
    user_id: str
    app_id: str
    event_type: str
    event_time: dt.datetime
    raw_json: Dict[str, Any]
    
    @validator('event_time')
    def validate_event_time(cls, v):
        if v > dt.datetime.now():
            raise ValueError('Event time cannot be in the future')
        return v

class DailyLogIn(BaseModel):
    user_id: str
    date: dt.date
    mood: Optional[int] = Field(None, ge=1, le=10)
    stress: Optional[int] = Field(None, ge=1, le=10)
    energy: Optional[int] = Field(None, ge=1, le=10)
    focus: Optional[int] = Field(None, ge=1, le=10)
    notes: Optional[str] = None
    journal_entry: Optional[str] = None
    coping_strategies: Optional[List[str]] = None
    # Menstrual cycle tracking
    menstrual_phase: Optional[str] = Field(None, regex="^(period|follicular|luteal|ovulation)$")
    cycle_day: Optional[int] = Field(None, ge=1, le=35)
    # Daily flare tracking (target variable for ML)
    daily_flare_status: Optional[bool] = False
    flare_type: Optional[str] = Field(None, regex="^(gut|skin|mental|both|all)$")
    flare_severity: Optional[int] = Field(None, ge=0, le=10)
    flare_duration_hours: Optional[int] = None
    # Recovery/relaxation activities
    recovery_activities: Optional[List[str]] = None
    meditation_minutes: Optional[int] = Field(None, ge=0)
    relaxation_quality: Optional[int] = Field(None, ge=1, le=10)

class SymptomIn(BaseModel):
    user_id: str
    date: dt.date
    type: str
    severity: int = Field(ge=0, le=10)
    onset_time: Optional[dt.time] = None
    duration_min: Optional[int] = None
    location: Optional[str] = None
    triggers: Optional[List[str]] = None
    notes: Optional[str] = None
    # GI specific fields
    reflux_severity: Optional[int] = Field(None, ge=0, le=10)
    bloating_severity: Optional[int] = Field(None, ge=0, le=10)
    abdominal_pain_severity: Optional[int] = Field(None, ge=0, le=10)
    stool_consistency: Optional[int] = Field(None, ge=1, le=7)  # Bristol stool scale
    # Skin specific fields
    skin_location: Optional[str] = None  # "face", "chest", "back", "arms", etc.
    skin_type: Optional[str] = None  # "acne", "rash", "itchiness", "dryness"
    # General health
    fatigue_severity: Optional[int] = Field(None, ge=0, le=10)
    headache_severity: Optional[int] = Field(None, ge=0, le=10)

class MealIn(BaseModel):
    user_id: str
    ts: dt.datetime
    items: str
    food_type: Optional[str] = Field(None, regex="^(breakfast|lunch|dinner|snack)$")
    portion_size: Optional[str] = Field(None, regex="^(small|medium|large|exact_grams)$")
    portion_grams: Optional[int] = Field(None, ge=0)
    tags: List[str] = []
    calories: Optional[int] = None
    caffeine_mg: Optional[int] = None
    # Macronutrients (per serving)
    protein_g: Optional[float] = Field(None, ge=0)
    carbs_g: Optional[float] = Field(None, ge=0)
    fat_g: Optional[float] = Field(None, ge=0)
    fiber_g: Optional[float] = Field(None, ge=0)
    sugar_g: Optional[float] = Field(None, ge=0)
    # Additional macronutrients
    saturated_fat_g: Optional[float] = Field(None, ge=0)
    monounsaturated_fat_g: Optional[float] = Field(None, ge=0)
    polyunsaturated_fat_g: Optional[float] = Field(None, ge=0)
    trans_fat_g: Optional[float] = Field(None, ge=0)
    cholesterol_mg: Optional[float] = Field(None, ge=0)
    sodium_mg: Optional[float] = Field(None, ge=0)
    potassium_mg: Optional[float] = Field(None, ge=0)
    # Micronutrients
    vitamin_c_mg: Optional[float] = Field(None, ge=0)
    vitamin_d_iu: Optional[float] = Field(None, ge=0)
    calcium_mg: Optional[float] = Field(None, ge=0)
    iron_mg: Optional[float] = Field(None, ge=0)
    magnesium_mg: Optional[float] = Field(None, ge=0)
    zinc_mg: Optional[float] = Field(None, ge=0)
    artificial_sweeteners: Optional[bool] = False

class SleepSessionIn(BaseModel):
    user_id: str
    start_time: dt.datetime
    end_time: dt.datetime
    total_min: Optional[int] = None
    deep_min: Optional[int] = None
    light_min: Optional[int] = None
    rem_min: Optional[int] = None
    awake_min: Optional[int] = None
    awakenings: Optional[int] = None
    sleep_score: Optional[float] = Field(None, ge=1, le=10)
    sleep_factors: Optional[Dict[str, bool]] = None
    notes: Optional[str] = None

class WorkoutIn(BaseModel):
    user_id: str
    ts: dt.datetime
    type: str
    duration_min: Optional[int] = None
    intensity: Optional[int] = Field(None, ge=1, le=5)
    calories_burned: Optional[int] = None
    heart_rate_avg: Optional[int] = None
    heart_rate_max: Optional[int] = None
    notes: Optional[str] = None

class VitalIn(BaseModel):
    user_id: str
    date: dt.date
    hr_mean: Optional[float] = None
    hr_max: Optional[float] = None
    hrv_ms: Optional[float] = None
    spo2: Optional[float] = None
    steps: Optional[int] = None
    active_min: Optional[int] = None
    calories_burned: Optional[int] = None

class MedicationIn(BaseModel):
    med_code: str
    name: str
    category: str = "prescription"
    instructions: Optional[str] = None
    side_effects: Optional[List[str]] = None
    interactions: Optional[List[str]] = None

class MedAdherenceIn(BaseModel):
    user_id: str
    med_code: str
    ts: dt.datetime
    status: str = Field(..., regex="^(taken|missed|late|skipped)$")
    notes: Optional[str] = None

class RemedyIn(BaseModel):
    user_id: str
    name: str
    category: str
    effectiveness_score: Optional[float] = Field(None, ge=0, le=10)
    usage_count: int = 0
    conditions: Optional[List[str]] = None
    instructions: Optional[str] = None

class ImageIn(BaseModel):
    user_id: str
    ts: dt.datetime
    path: str
    body_region: Optional[str] = None
    lighting: Optional[str] = None
    camera_info: Optional[Dict[str, Any]] = None

class JournalIn(BaseModel):
    user_id: str
    ts: dt.datetime
    text: str
    mood_context: Optional[int] = Field(None, ge=1, le=10)
    stress_context: Optional[int] = Field(None, ge=1, le=10)

#########################
# 3) DATA INGESTION      #
#########################

def calculate_payload_hash(payload: Dict[str, Any]) -> str:
    """Calculate hash for idempotency."""
    payload_str = json.dumps(payload, sort_keys=True)
    return hashlib.md5(payload_str.encode()).hexdigest()

def upsert_event(event: EventIn) -> int:
    """Insert or update event with idempotency."""
    payload_hash = calculate_payload_hash(event.raw_json)
    
    with get_conn() as conn:
        # Check if event already exists
        existing = conn.execute(
            "SELECT event_id FROM events WHERE payload_hash = ? AND user_id = ?",
            (payload_hash, event.user_id)
        ).fetchone()
        
        if existing:
            return existing[0]
        
        # Insert new event
        cursor = conn.execute(
            """INSERT INTO events (user_id, app_id, event_type, event_time, payload_hash, raw_json)
               VALUES (?, ?, ?, ?, ?, ?)""",
            (event.user_id, event.app_id, event.event_type, 
             event.event_time.isoformat(), payload_hash, json.dumps(event.raw_json))
        )
        return cursor.lastrowid

def upsert_daily_log(log: DailyLogIn) -> None:
    """Insert or update daily log."""
    with get_conn() as conn:
        conn.execute(
            """INSERT OR REPLACE INTO daily_logs 
               (user_id, date, mood, stress, energy, focus, notes, journal_entry, coping_strategies)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
            (log.user_id, log.date.isoformat(), log.mood, log.stress, log.energy, 
             log.focus, log.notes, log.journal_entry, 
             json.dumps(log.coping_strategies) if log.coping_strategies else None)
        )

def insert_symptom(symptom: SymptomIn) -> int:
    """Insert symptom record."""
    with get_conn() as conn:
        cursor = conn.execute(
            """INSERT INTO symptoms (user_id, date, type, severity, onset_time, duration_min, location, triggers, notes)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
            (symptom.user_id, symptom.date.isoformat(), symptom.type, symptom.severity,
             symptom.onset_time.isoformat() if symptom.onset_time else None,
             symptom.duration_min, symptom.location,
             json.dumps(symptom.triggers) if symptom.triggers else None,
             symptom.notes)
        )
        return cursor.lastrowid

def insert_meal(meal: MealIn) -> int:
    """Insert meal record with detailed macronutrients."""
    with get_conn() as conn:
        cursor = conn.execute(
            """INSERT INTO meals (user_id, ts, items, food_type, portion_size, portion_grams, tags, calories, caffeine_mg, 
               protein_g, carbs_g, fat_g, fiber_g, sugar_g, saturated_fat_g, monounsaturated_fat_g, polyunsaturated_fat_g, 
               trans_fat_g, cholesterol_mg, sodium_mg, potassium_mg, vitamin_c_mg, vitamin_d_iu, calcium_mg, iron_mg, 
               magnesium_mg, zinc_mg, artificial_sweeteners)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)""",
            (meal.user_id, meal.ts.isoformat(), meal.items, meal.food_type, meal.portion_size, meal.portion_grams,
             json.dumps(meal.tags), meal.calories, meal.caffeine_mg, meal.protein_g, meal.carbs_g, meal.fat_g, 
             meal.fiber_g, meal.sugar_g, meal.saturated_fat_g, meal.monounsaturated_fat_g, meal.polyunsaturated_fat_g,
             meal.trans_fat_g, meal.cholesterol_mg, meal.sodium_mg, meal.potassium_mg, meal.vitamin_c_mg, 
             meal.vitamin_d_iu, meal.calcium_mg, meal.iron_mg, meal.magnesium_mg, meal.zinc_mg, meal.artificial_sweeteners)
        )
        return cursor.lastrowid

def insert_sleep_session(sleep: SleepSessionIn) -> int:
    """Insert sleep session record."""
    with get_conn() as conn:
        cursor = conn.execute(
            """INSERT INTO sleep_sessions (user_id, start_time, end_time, total_min, deep_min, light_min, rem_min, awake_min, awakenings, sleep_score, sleep_factors, notes)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)""",
            (sleep.user_id, sleep.start_time.isoformat(), sleep.end_time.isoformat(),
             sleep.total_min, sleep.deep_min, sleep.light_min, sleep.rem_min, 
             sleep.awake_min, sleep.awakenings, sleep.sleep_score,
             json.dumps(sleep.sleep_factors) if sleep.sleep_factors else None,
             sleep.notes)
        )
        return cursor.lastrowid

def insert_workout(workout: WorkoutIn) -> int:
    """Insert workout record."""
    with get_conn() as conn:
        cursor = conn.execute(
            """INSERT INTO workouts (user_id, ts, type, duration_min, intensity, calories_burned, heart_rate_avg, heart_rate_max, notes)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
            (workout.user_id, workout.ts.isoformat(), workout.type, workout.duration_min,
             workout.intensity, workout.calories_burned, workout.heart_rate_avg,
             workout.heart_rate_max, workout.notes)
        )
        return cursor.lastrowid

def insert_vital(vital: VitalIn) -> int:
    """Insert vital record."""
    with get_conn() as conn:
        cursor = conn.execute(
            """INSERT INTO vitals (user_id, date, hr_mean, hr_max, hrv_ms, spo2, steps, active_min, calories_burned)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
            (vital.user_id, vital.date.isoformat(), vital.hr_mean, vital.hr_max,
             vital.hrv_ms, vital.spo2, vital.steps, vital.active_min, vital.calories_burned)
        )
        return cursor.lastrowid

def insert_journal(journal: JournalIn) -> int:
    """Insert journal record."""
    with get_conn() as conn:
        cursor = conn.execute(
            """INSERT INTO journals (user_id, ts, text, mood_context, stress_context)
               VALUES (?, ?, ?, ?, ?)""",
            (journal.user_id, journal.ts.isoformat(), journal.text,
             journal.mood_context, journal.stress_context)
        )
        return cursor.lastrowid

if __name__ == "__main__":
    # Initialize database
    init_db()
    print("🚀 Unified Health AI System initialized!")
    print(f"Database: {DB_PATH}")
    print("Ready for data ingestion and ML processing!")
